<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Auth Test</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
</head>
<body>
    <h1>Firebase Auth Test</h1>
    <div id="auth-container">
        <input type="email" id="email" placeholder="Email">
        <input type="password" id="password" placeholder="Password">
        <button onclick="signUp()">Sign Up</button>
        <button onclick="login()">Login</button>
        <button onclick="logout()">Logout</button>
    </div>
    <button onclick="accessProtectedContent()">Access Protected Content</button>
    <div id="result"></div>

    <script>
        // Your Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAcr0JlLKucSQfzEJmVRK8_0ETURHnrSb8",
            // Add other configuration options here
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);

        // Get elements
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const resultDiv = document.getElementById('result');

        // Check for existing session on page load
        document.addEventListener('DOMContentLoaded', () => {
            firebase.auth().onAuthStateChanged((user) => {
                if (user) {
                    resultDiv.innerHTML = `Logged in as ${user.email}`;
                } else {
                    resultDiv.innerHTML = 'Not logged in';
                }
            });
        });

        // Sign up function
        function signUp() {
            const email = emailInput.value;
            const password = passwordInput.value;
            firebase.auth().createUserWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    setSessionCookie(userCredential.user);
                    resultDiv.innerHTML = `Signup successful for ${userCredential.user.email}`;
                })
                .catch((error) => {
                    resultDiv.innerHTML = `Signup error: ${error.message}`;
                });
        }

        // Login function
        function login() {
            const email = emailInput.value;
            const password = passwordInput.value;
            firebase.auth().signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    setSessionCookie(userCredential.user);
                    resultDiv.innerHTML = `Login successful for ${userCredential.user.email}`;
                })
                .catch((error) => {
                    resultDiv.innerHTML = `Login error: ${error.message}`;
                });
        }

        // Logout function
        function logout() {
            firebase.auth().signOut()
                .then(() => {
                    clearSessionCookie();
                    resultDiv.innerHTML = 'Logged out successfully';
                })
                .catch((error) => {
                    resultDiv.innerHTML = `Logout error: ${error.message}`;
                });
        }

        // Access protected content
        async function accessProtectedContent() {
            const user = firebase.auth().currentUser;
            if (user) {
                try {
                    const idToken = await user.getIdToken(true);
                    const response = await fetch('http://localhost:8000/api/users/protected', {
                        headers: {
                            'Authorization': `Bearer ${idToken}`
                        }
                    });
                    const data = await response.json();
                    resultDiv.innerHTML = `Protected content: ${JSON.stringify(data)}`;
                } catch (error) {
                    resultDiv.innerHTML = `Error accessing protected content: ${error.message}`;
                }
            } else {
                resultDiv.innerHTML = 'User not logged in';
            }
        }

        // Set session cookie
        function setSessionCookie(user) {
            user.getIdToken(true).then((idToken) => {
                document.cookie = `session=${idToken}; path=/; max-age=3600; SameSite=Strict; Secure`;
            });
        }

        // Clear session cookie
        function clearSessionCookie() {
            document.cookie = 'session=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT; SameSite=Strict; Secure';
        }

        // Token renewal
        firebase.auth().onAuthStateChanged((user) => {
            if (user) {
                setSessionCookie(user);
            } else {
                clearSessionCookie();
            }
        });
    </script>
</body>
</html>
