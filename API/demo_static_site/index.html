<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Keycloak Registration Demo</title>
   
</head>
<body>



    <h1>User Authentication Demo</h1>

    <div id="authForms">
        <h2>Sign Up</h2>
        <form id="signupForm">
            <input type="email" id="signupEmail" placeholder="Email" required>
            <input type="password" id="signupPassword" placeholder="Password" required>
            <button type="submit">Sign Up</button>
        </form>

        <h2>Login</h2>
        <form id="loginForm">
            <input type="email" id="loginEmail" placeholder="Email" required>
            <input type="password" id="loginPassword" placeholder="Password" required>
            <button type="submit">Login</button>
        </form>
    </div>

    <div id="userProfile" class="hidden">
        <h2>User Profile</h2>
        <p>Username: <span id="username"></span></p>
        <p>Email: <span id="email"></span></p>
        <button id="logoutButton">Logout</button>
    </div>

    <script>
        const API_URL = 'http://localhost:3000';
        let accessToken = null;

        function showProfile(data) {
            document.getElementById('authForms').classList.add('hidden');
            document.getElementById('userProfile').classList.remove('hidden');
            document.getElementById('username').textContent = data.preferred_username;
            document.getElementById('email').textContent = data.email || 'N/A';
        }

        function showAuthForms() {
            document.getElementById('authForms').classList.remove('hidden');
            document.getElementById('userProfile').classList.add('hidden');
        }

        document.getElementById('signupForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;

            try {
                const response = await fetch(`${API_URL}/signup`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: email, password })
                });
                const data = await response.json();
                if (response.ok) {
                    accessToken = data.access_token;
                    alert('Signup successful! You can now log in.');
                } else {
                    throw new Error(data.detail || 'Signup failed');
                }
            } catch (error) {
                alert(error.message);
            }
        });

        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            try {
                const response = await fetch(`${API_URL}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `username=${encodeURIComponent(email)}&password=${encodeURIComponent(password)}`
                });
                const data = await response.json();
                if (response.ok) {
                    accessToken = data.access_token;
                    fetchUserInfo();
                } else {
                    throw new Error(data.detail || 'Login failed');
                }
            } catch (error) {
                alert(error.message);
            }
        });

        async function fetchUserInfo() {
            try {
                const response = await fetch(`${API_URL}/protected`, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                const data = await response.json();
                if (response.ok) {
                    showProfile(data);
                } else {
                    throw new Error(data.detail || 'Failed to fetch user info');
                }
            } catch (error) {
                alert(error.message);
            }
        }

        document.getElementById('logoutButton').addEventListener('click', () => {
            accessToken = null;
            showAuthForms();
        });
    </script>
</body>
</html>